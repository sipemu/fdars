---
title: "Functional Depth Functions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Functional Depth Functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(

  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Introduction

Functional depth is a measure of how "central" or "typical" a curve is within
a sample of curves. Curves with high depth are considered representative of
the sample, while curves with low depth are outliers or extreme observations.

Depth functions extend the concept of statistical depth (like data depth for
multivariate data) to the infinite-dimensional setting of functional data.

```{r setup}
library(fdars)

# Create example data
set.seed(42)
n <- 30
m <- 100
t_grid <- seq(0, 1, length.out = m)

# Main sample: sine curves with noise
X <- matrix(0, n, m)
for (i in 1:n) {
  X[i, ] <- sin(2 * pi * t_grid) + rnorm(m, sd = 0.15)
}

# Add some outliers
X[1, ] <- sin(2 * pi * t_grid) + 2  # Magnitude outlier
X[2, ] <- cos(2 * pi * t_grid)       # Shape outlier

fd <- fdata(X, argvals = t_grid)
plot(fd)
```

## Available Depth Functions

### Fraiman-Muniz Depth (depth.FM)

The Fraiman-Muniz depth integrates univariate depths across the domain.
For each time point, it computes the proportion of curves above and below
the given curve, then averages across time.

```{r depth-fm}
depths_fm <- depth.FM(fd)

# Show depths (outliers should have lower depth)
data.frame(
  curve = 1:5,
  depth = round(depths_fm[1:5], 4),
  note = c("magnitude outlier", "shape outlier", rep("normal", 3))
)
```

The FM depth can be scaled to [0, 1] using the `scale` parameter:

```{r depth-fm-scaled}
depths_fm_scaled <- depth.FM(fd, scale = TRUE)
range(depths_fm_scaled)
```

### Modal Depth (depth.mode)

Modal depth uses kernel density estimation in function space. Curves in
high-density regions have high depth.

```{r depth-mode}
depths_mode <- depth.mode(fd)
head(depths_mode)
```

### Random Projection Depth (depth.RP)

Projects curves onto random directions and computes univariate depths
of the projections. More robust to local variations.

```{r depth-rp}
depths_rp <- depth.RP(fd, nproj = 50)
head(depths_rp)
```

### Random Tukey Depth (depth.RT)

Takes the minimum depth across random projections, similar to Tukey's
halfspace depth. Very robust to outliers.

```{r depth-rt}
depths_rt <- depth.RT(fd, nproj = 50)
head(depths_rt)
```

### Functional Spatial Depth (depth.FSD)

Based on unit vectors pointing from each curve to all others. Measures
centrality in a geometric sense.

```{r depth-fsd}
depths_fsd <- depth.FSD(fd)
head(depths_fsd)
```

### Kernel Functional Spatial Depth (depth.KFSD)

Smoothed version of FSD using a Gaussian kernel. The bandwidth `h`
controls the smoothing.

```{r depth-kfsd}
depths_kfsd <- depth.KFSD(fd, h = 0.15)
head(depths_kfsd)
```

### Random Projection Depth with Derivatives (depth.RPD)

Incorporates derivative information, making it sensitive to shape
changes in addition to magnitude.

```{r depth-rpd}
depths_rpd <- depth.RPD(fd, nproj = 50)
head(depths_rpd)
```

## Comparing Depth Functions

Different depth functions have different properties and may rank curves
differently:

```{r compare-depths}
# Compute all depths
all_depths <- data.frame(
  FM = depth.FM(fd),
  mode = depth.mode(fd),
  RP = depth.RP(fd, nproj = 50),
  RT = depth.RT(fd, nproj = 50),
  FSD = depth.FSD(fd)
)

# Correlation between depth functions
round(cor(all_depths), 2)
```

```{r depth-comparison-plot}
# Which curves are identified as outliers (lowest depth)?
outlier_ranks <- apply(all_depths, 2, function(d) order(d)[1:3])
outlier_ranks
```

All depth functions correctly identify curves 1 and 2 as having low depth.

## Depth-Based Statistics

### Functional Median

The median is the curve with maximum depth:

```{r median}
# Using different depth functions
med_fm <- median.FM(fd)
med_mode <- median.mode(fd)
med_rp <- median.RP(fd, nproj = 50)

# The median is one of the original curves
which.max(depth.FM(fd))
```

### Trimmed Mean

Remove a proportion of curves with lowest depth, then compute the mean:

```{r trimmed-mean}
# 10% trimmed mean
trim_fm <- trimmed.FM(fd, trim = 0.1)
trim_mode <- trimmed.mode(fd, trim = 0.1)

# Compare trimmed mean to regular mean
mean_curve <- mean(fd)
```

```{r plot-robust}
# Visualize: trimmed mean is more robust to outliers
df_compare <- data.frame(
  t = rep(t_grid, 2),
  value = c(mean_curve, trim_fm$data[1, ]),
  type = rep(c("Mean", "Trimmed Mean (FM)"), each = m)
)

library(ggplot2)
ggplot(df_compare, aes(x = t, y = value, color = type)) +
  geom_line(linewidth = 1.2) +
  labs(title = "Mean vs Trimmed Mean",
       x = "t", y = "X(t)", color = "") +
  theme_minimal()
```

### Functional Variance and Trimmed Variance

```{r variance}
# Regular variance
var_fd <- var(fd)

# Trimmed variance (more robust)
trimvar_fd <- trimvar.FM(fd, trim = 0.1)
```

## Choosing a Depth Function

| Depth | Strengths | Best For |
|-------|-----------|----------|
| FM | Simple, interpretable | General use |
| mode | Sensitive to local density | Multimodal data |
| RP | Robust, fast | Large datasets |
| RT | Very robust | Heavy outlier contamination |
| FSD | Geometric interpretation | Spatial patterns |
| KFSD | Smooth, tunable | When smoothness matters |
| RPD | Shape-sensitive | When derivatives matter |

## Performance

All depth computations use a parallel Rust backend:

```{r performance, eval=FALSE}
# Large dataset benchmark
X_large <- matrix(rnorm(500 * 200), 500, 200)
fd_large <- fdata(X_large)

system.time(depth.FM(fd_large))
#>    user  system elapsed
#>   0.032   0.000   0.032

system.time(depth.RP(fd_large, nproj = 100))
#>    user  system elapsed
#>   0.089   0.000   0.089
```

## References

- Fraiman, R. and Muniz, G. (2001). Trimmed means for functional data.
  *Test*, 10(2), 419-440.
- Cuevas, A., Febrero, M., and Fraiman, R. (2007). Robust estimation and
  classification for functional data via projection-based depth notions.
  *Computational Statistics*, 22(3), 481-496.
- LÃ³pez-Pintado, S. and Romo, J. (2009). On the concept of depth for
  functional data. *Journal of the American Statistical Association*,
  104(486), 718-734.
